replicaCount: 1

image:
  repository: kubernetes-platform-stack
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "80"
  prometheus.io/path: "/metrics"
  # Cilium BGP annotation for LoadBalancer IP advertisement
  io.cilium/bgp-advertise: "true"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true

service:
  type: LoadBalancer
  port: 80
  targetPort: 80
  annotations:
    # Cilium BGP LoadBalancer annotation
    io.cilium/bgp-advertise: "true"
  # Optional: specify LoadBalancer IP from your BGP pool
  # loadBalancerIP: "10.0.0.100"

ingress:
  enabled: false
  className: "istio"
  annotations: {}
  hosts:
    - host: my-app.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Pod Disruption Budget for high availability
podDisruptionBudget:
  enabled: true
  minAvailable: 0

nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - my-app
          topologyKey: kubernetes.io/hostname

livenessProbe:
  httpGet:
    path: /
    port: 80
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /
    port: 80
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

config:
  logLevel: "INFO"
  environment: "production"

env:
  - name: LOG_LEVEL
    value: "INFO"
  - name: PORT
    value: "80"

# Istio VirtualService configuration
istio:
  enabled: true
  virtualService:
    enabled: true
    hosts:
      - "*"
    gateways:
      - istio-ingressgateway
    http:
      - match:
          - uri:
              prefix: /
        route:
          - destination:
              host: my-app
              port:
                number: 80
              subset: v1
            weight: 100
        timeout: 30s
        retries:
          attempts: 3
          perTryTimeout: 10s

  # Destination Rule for load balancing policy
  destinationRule:
    enabled: true
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
        http:
          http1MaxPendingRequests: 100
          http2MaxRequests: 1000
          maxRequestsPerConnection: 2
      outlierDetection:
        consecutiveErrors: 5
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 50
        minRequestVolume: 5
    subsets:
      - name: v1
        labels:
          version: v1

  # Peer Authentication (mTLS)
  peerAuthentication:
    enabled: true
    mtls:
      mode: STRICT

  # Authorization Policy
  authorizationPolicy:
    enabled: true
    rules:
      - from:
          - source:
              principals:
                - "cluster.local/ns/default/sa/default"
        to:
          - operation:
              methods:
                - GET
                - POST
              paths:
                - /api/*
                - /health
                - /ready

# Prometheus ServiceMonitor for metrics scraping
prometheus:
  enabled: true
  interval: 30s
  path: /metrics

# Network Policy for security
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
      ports:
        - protocol: TCP
          port: 80
    - from:
        - podSelector:
            matchLabels:
              app: my-app
      ports:
        - protocol: TCP
          port: 80
