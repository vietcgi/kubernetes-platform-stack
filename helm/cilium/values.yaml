# Cilium Helm Chart Values
# Configured for BGP, kube-proxy replacement, and native LoadBalancer

cilium:
  # Cilium version (v1.18.3 stable - tested with KIND)
  image:
    repository: quay.io/cilium/cilium
    tag: v1.18.3
    pullPolicy: IfNotPresent

  # IPAM configuration
  ipam:
    mode: kubernetes

  # Enable BGP Control Plane for LoadBalancer IP advertisement
  bgp:
    enabled: true
    announce:
      loadbalancerIP: true
      podCIDR: true

  # BGP Configuration (peer settings)
  bgpControlPlane:
    enabled: true
    secretsNamespace: kube-system

  # Native LoadBalancer service support
  # Use L2 for KIND, BGP for production
  loadBalancer:
    l2:
      enabled: true
      # Enable L2 announcements for KIND stability
      interfaces:
      - eth0
    algorithm: maglev
    mode: snat

  # Kube-proxy replacement enabled for proper DNS and service resolution
  # CRITICAL: This must be enabled for CoreDNS and service DNS resolution to work properly
  # The --set flags in deploy.sh override this value to ensure it's always enabled
  kubeProxyReplacement: true

  # eBPF-based kube-proxy replacement features disabled
  bpf:
    # Native socket load balancing disabled on Docker Desktop
    sockLB:
      enabled: false
    # Host datapath acceleration disabled on Docker Desktop
    hostLB:
      enabled: false
    # Connection tracking disabled on Docker Desktop
    ctAny:
      enabled: false
    # Program Pin Path
    mapShare: true

  # Cluster networking
  cluster:
    name: platform
    id: 1

  # Security - mTLS within cluster
  hubble:
    enabled: true
    relay:
      enabled: true
    ui:
      enabled: true
      backend:
        service:
          type: ClusterIP

  # Observability - Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
    serviceMonitor:
      enabled: true
      namespace: monitoring
      interval: 30s

  # Network Policy engine
  # NOTE: Policy enforcement disabled (set to 'none') to avoid circular dependency
  # that blocks DNS resolution in development environments
  # For production, set to 'default' and implement NetworkPolicies
  networkPolicy:
    enabled: false

  # Policy Enforcement Mode
  # Set to 'none' to disable policy enforcement but keep NetworkPolicy CRDs available
  policyEnforcementMode: "none"

  # Pod Execution Spaces
  podExecutionSpaces:
    enabled: false

  # DNS Policy (optional, for DNS proxying)
  dnsPolicy: ClusterFirstWithHostNet

  # Resources (adjust based on cluster size)
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 128Mi

  # Node affinity for BGP nodes (if using labels)
  nodeSelector:
    kubernetes.io/os: linux

  # Tolerations for node taints
  tolerations:
    - operator: Exists
      effect: NoSchedule
    - operator: Exists
      effect: NoExecute

  # Host networking
  hostNetwork: true

  # Privileged mode required for eBPF
  privileged: true

  # Update strategy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 2

  # Environment variables
  env:
    CILIUM_ENABLE_ENVOY_CONFIG_API: "false"
    CILIUM_ENABLE_HUBBLE_OPEN_METRICS: "true"
    CILIUM_HUBBLE_METRICS_PORT: "9091"
    # Increase Kubernetes API client timeout for Docker Desktop bootstrap
    KUBE_CLIENT_TIMEOUT: "180s"
    KUBE_CLIENT_BACKOFF_DURATION: "180"

# BGP Configuration Templates - will be created as separate manifests
bgp:
  # BGP Cluster Config
  clusterConfig:
    enabled: true
    localASN: 64512
    routerID: "10.0.0.1"  # Adjust based on your cluster
    exportPodCIDR: true
    nodeSelector:
      bgp: "enabled"

  # BGP Peer Configuration (for peering with external routers)
  neighbors:
    enabled: false  # Set to true if you have external BGP routers
    # Example peer config (uncomment to use)
    # - peerAddress: "10.0.0.254"
    #   asn: 64513
    #   gracefulRestart:
    #     enabled: true
    #     restartTimeSeconds: 120

  # BGP Advertisement Policy (what to announce)
  advertisements:
    enabled: true
    loadBalancerIPs: true
    podCIDRs: true
    clusterIP: false  # Set true if v1.17.0+ and want to advertise ClusterIPs

# Additional network policies template variables
networkPolicies:
  enabled: true
  # Label selector for workloads to apply policies to
  selector:
    app: my-app

  # Default policy: deny all ingress
  defaultDeny: true

# Monitoring configuration
monitoring:
  enabled: true
  namespace: monitoring
