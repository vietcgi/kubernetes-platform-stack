{{- if .Values.serviceMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "blackbox-exporter.fullname" . }}
  namespace: {{ .Values.serviceMonitor.namespace | quote }}
  labels:
{{- include "blackbox-exporter.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
{{- include "blackbox-exporter.selectorLabels" . | nindent 6 }}
  endpoints:
  - port: http
    interval: {{ .Values.serviceMonitor.interval }}
    scrapeTimeout: {{ .Values.serviceMonitor.scrapeTimeout }}
    params:
      module: [http_2xx]
---
# PrometheusRule for synthetic monitoring alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "blackbox-exporter.fullname" . }}
  namespace: {{ .Values.serviceMonitor.namespace | quote }}
  labels:
{{- include "blackbox-exporter.labels" . | nindent 4 }}
spec:
  groups:
  - name: blackbox-synthetic-monitoring
    interval: {{ .Values.serviceMonitor.interval }}
    rules:
    # Endpoint availability alerts
    - alert: EndpointDown
      expr: probe_success == 0
      for: 5m
      labels:
        severity: critical
        component: synthetic-monitoring
      annotations:
        summary: "Endpoint {{ "{{ $labels.instance }}" }} is down"
        description: "Endpoint has been down for 5+ minutes"

    # TLS certificate expiration
    - alert: SSLCertificateExpiringSoon
      expr: probe_ssl_earliest_cert_expiry - time() < 604800
      for: 1h
      labels:
        severity: warning
        component: certificates
      annotations:
        summary: "SSL certificate for {{ "{{ $labels.instance }}" }} expiring soon"
        description: "Certificate will expire in {{ "{{ $value | humanizeDuration }}" }}"

    - alert: SSLCertificateExpiringCritical
      expr: probe_ssl_earliest_cert_expiry - time() < 86400
      for: 1h
      labels:
        severity: critical
        component: certificates
      annotations:
        summary: "SSL certificate for {{ "{{ $labels.instance }}" }} expiring critically"
        description: "Certificate will expire in {{ "{{ $value | humanizeDuration }}" }}"

    # DNS resolution failures
    - alert: DNSResolutionFailure
      expr: probe_dns_lookup_time_seconds == 0
      for: 5m
      labels:
        severity: warning
        component: dns
      annotations:
        summary: "DNS resolution failed for {{ "{{ $labels.instance }}" }}"
        description: "Unable to resolve DNS name"

    # High latency alerts
    - alert: EndpointHighLatency
      expr: probe_duration_seconds > 5
      for: 5m
      labels:
        severity: warning
        component: performance
      annotations:
        summary: "High latency for {{ "{{ $labels.instance }}" }}"
        description: "Endpoint response time is {{ "{{ $value }}" }}s (threshold: 5s)"

    # HTTP status code issues
    - alert: HTTPStatusCodeError
      expr: probe_http_status_code >= 400 and probe_http_status_code < 500
      for: 5m
      labels:
        severity: warning
        component: http
      annotations:
        summary: "HTTP {{ "{{ $value }}" }} error for {{ "{{ $labels.instance }}" }}"
        description: "Endpoint returning client error (4xx)"

    - alert: HTTPStatusCodeServerError
      expr: probe_http_status_code >= 500
      for: 5m
      labels:
        severity: critical
        component: http
      annotations:
        summary: "HTTP {{ "{{ $value }}" }} error for {{ "{{ $labels.instance }}" }}"
        description: "Endpoint returning server error (5xx)"
{{- end }}
