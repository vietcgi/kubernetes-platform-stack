---
# System Namespace Network Policies
# Security policies for kube-system and other system namespaces

# Allow API Server webhook communication (cert-manager, vault)
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-apiserver-webhook
  namespace: kube-system
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: system
spec:
  endpointSelector:
    matchLabels:
      component: kube-apiserver
  description: "Allow API server to call webhooks on port 443 and 9443"
  egress:
  # Allow to any HTTPS endpoint (for webhooks)
  - toPorts:
    - ports:
      - port: "443"
        protocol: TCP
      - port: "9443"
        protocol: TCP
      - port: "9502"
        protocol: TCP  # Longhorn webhook
      - port: "15017"
        protocol: TCP  # Istio webhook

---
# Kubelet API access from API Server
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-kubelet-access
  namespace: kube-system
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: system
spec:
  endpointSelector:
    matchLabels:
      component: kubelet
  description: "Allow kubelet API access from system pods"
  ingress:
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "10250"
        protocol: TCP

---
# Vault Namespace Network Policy
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: vault
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: core
spec:
  endpointSelector: {}
  description: "Allow pod-to-pod communication within vault namespace and external-secrets access"
  ingress:
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: vault
    toPorts:
    - ports:
      - port: "8200"
        protocol: TCP
      - port: "8201"
        protocol: TCP
  # Allow External Secrets to access Vault API
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: external-secrets
    toPorts:
    - ports:
      - port: "8200"
        protocol: TCP
  egress:
  # Allow communication within namespace
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: vault
  # Allow DNS resolution
  - toEndpoints:
    - matchLabels:
        k8s-app: coredns
        io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  # Allow Kubernetes API access on HTTPS
  - toEntities:
    - "kube-apiserver"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
