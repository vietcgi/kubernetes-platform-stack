---
# Kubernetes Platform Stack - Core Network Policies
# Centralized network security policy management
# Applied via ArgoCD for GitOps-based control

# DNS Resolution Policy (kube-system)
# Required for all pods to resolve DNS names
# Matches CoreDNS pods by label - supports both old (kube-dns) and new (coredns) deployments
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-dns
  namespace: kube-system
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: core
spec:
  endpointSelector:
    matchLabels:
      k8s-app: coredns
  description: "Allow DNS resolution from all pods to CoreDNS"
  ingress:
  - toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP

---
# Inter-pod Communication Policy (Default namespace)
# Allow pods in the same namespace to communicate
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: default
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: core
spec:
  endpointSelector: {}
  description: "Allow pod-to-pod communication within default namespace"
  ingress:
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: default
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      - port: "8443"
        protocol: TCP
      - port: "9090"
        protocol: TCP
  egress:
  # Allow communication within namespace
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: default
  # Allow DNS resolution
  - toEndpoints:
    - matchLabels:
        k8s-app: coredns
        io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP

---
# Monitoring Namespace Core Communication
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: monitoring
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: core
spec:
  endpointSelector: {}
  description: "Allow pod-to-pod communication within monitoring namespace and metrics scraping"
  ingress:
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: monitoring
    toPorts:
    - ports:
      - port: "3000"
        protocol: TCP  # Grafana
      - port: "9090"
        protocol: TCP  # Prometheus
      - port: "3100"
        protocol: TCP  # Loki
      - port: "3200"
        protocol: TCP  # Tempo
      - port: "8080"
        protocol: TCP  # Application metrics
  egress:
  # Allow communication within namespace
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: monitoring
  # Allow DNS resolution
  - toEndpoints:
    - matchLabels:
        k8s-app: coredns
        io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  # Allow Kubernetes API server access (required for admission webhooks)
  - toEntities:
    - "kube-apiserver"
  # Allow Prometheus to scrape metrics from any namespace
  - toEndpoints:
    - matchLabels: {}
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      - port: "9090"
        protocol: TCP
      - port: "9091"
        protocol: TCP
      - port: "9100"
        protocol: TCP  # Node exporter
      - port: "9153"
        protocol: TCP  # CoreDNS metrics
      - port: "10254"
        protocol: TCP  # Nginx ingress metrics

---
# Istio System Namespace Core Communication
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: istio-system
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: core
spec:
  endpointSelector: {}
  description: "Allow pod-to-pod communication within istio-system namespace"
  ingress:
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: istio-system
    toPorts:
    - ports:
      - port: "15012"
        protocol: TCP  # istiod xDS
      - port: "15017"
        protocol: TCP  # istiod webhook
      - port: "15014"
        protocol: TCP  # istiod metrics
  egress:
  # Allow communication within namespace
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: istio-system
  # Allow DNS resolution
  - toEndpoints:
    - matchLabels:
        k8s-app: coredns
        io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  # Istiod needs to reach API server
  - toEntities:
    - "kube-apiserver"

---
# ArgoCD Namespace Core Communication
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: argocd
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: core
spec:
  endpointSelector: {}
  description: "Allow pod-to-pod communication within argocd namespace"
  ingress:
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: argocd
    toPorts:
    - ports:
      - port: "6379"
        protocol: TCP  # Redis cache
      - port: "8080"
        protocol: TCP  # ArgoCD server
      - port: "8081"
        protocol: TCP  # ArgoCD repo-server
      - port: "8083"
        protocol: TCP  # ArgoCD gRPC
  egress:
  # Allow communication within namespace
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: argocd
  # Allow DNS resolution
  - toEndpoints:
    - matchLabels:
        k8s-app: coredns
        io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  # ArgoCD needs to reach Kubernetes API server
  - toEntities:
    - "kube-apiserver"
  # ArgoCD needs to reach external Git repos and Helm registries
  # Using world entity instead of FQDN rules for reliability
  - toEntities:
    - "world"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
      - port: "22"
        protocol: TCP  # Git SSH

---
# Cert-Manager Namespace Core Communication
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: network-policies
    app.kubernetes.io/component: core
spec:
  endpointSelector: {}
  description: "Allow pod-to-pod communication within cert-manager namespace"
  ingress:
  - fromEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: cert-manager
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP  # Webhook
      - port: "6443"
        protocol: TCP
      - port: "8080"
        protocol: TCP
      - port: "9402"
        protocol: TCP  # Metrics
  # Allow Kubernetes API server to call webhook
  - fromEntities:
    - "kube-apiserver"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  egress:
  # Allow communication within namespace
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: cert-manager
  # Allow DNS resolution
  - toEndpoints:
    - matchLabels:
        k8s-app: coredns
        io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  # Allow Kubernetes API server access (required for cert-manager-cainjector)
  - toEntities:
    - "kube-apiserver"
  # cert-manager needs to reach Let's Encrypt
  - toFQDNs:
    - matchName: "acme-v02.api.letsencrypt.org"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
