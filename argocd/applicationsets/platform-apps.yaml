# Enterprise ApplicationSet Template
# Generates all platform applications from a single source of truth
# Uses Helm repositories as the source for all applications
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: platform-applications
  namespace: argocd
  labels:
    app.kubernetes.io/name: platform-applicationset
    app.kubernetes.io/part-of: argocd
spec:
  goTemplate: true
  generators:
  # List-based generator using shared app configuration
  - list:
      elements:
      # Observability Stack
      - name: prometheus
        namespace: monitoring
        repoURL: https://prometheus-community.github.io/helm-charts
        chart: kube-prometheus-stack
        version: "79.4.1"
        syncPolicy: aggressive
        group: observability
        syncWave: 1

      - name: metrics-server
        namespace: kube-system
        repoURL: https://kubernetes-sigs.github.io/metrics-server/
        chart: metrics-server
        version: "3.12.2"
        syncPolicy: aggressive
        group: infrastructure
        syncWave: 0

      - name: loki
        namespace: monitoring
        repoURL: https://grafana.github.io/helm-charts
        chart: loki-stack
        version: "2.10.2"
        syncPolicy: aggressive
        group: observability
        syncWave: 1

      - name: tempo
        namespace: monitoring
        repoURL: https://grafana.github.io/helm-charts
        chart: tempo
        version: "1.24.0"
        syncPolicy: aggressive
        group: observability
        syncWave: 1

      # Service Mesh
      - name: istio
        namespace: istio-system
        repoURL: https://istio-release.storage.googleapis.com/charts
        chart: istiod
        version: "1.28.0"
        syncPolicy: conservative
        group: service_mesh
        syncWave: 2

      # Security Layer
      - name: cert-manager
        namespace: cert-manager
        repoURL: https://charts.jetstack.io
        chart: cert-manager
        version: "v1.19.1"
        syncPolicy: aggressive
        group: security
        syncWave: 0

      - name: vault
        namespace: vault
        repoURL: https://helm.releases.hashicorp.com
        chart: vault
        version: "0.31.0"
        syncPolicy: aggressive
        group: security
        syncWave: 3

      - name: falco
        namespace: falco
        repoURL: https://falcosecurity.github.io/charts
        chart: falco
        version: "4.21.0"
        syncPolicy: aggressive
        group: security
        syncWave: 3

      - name: kyverno
        namespace: kyverno
        repoURL: https://kyverno.github.io/kyverno
        chart: kyverno
        version: "3.6.0"
        syncPolicy: aggressive
        group: security
        syncWave: 3

      - name: sealed-secrets
        namespace: sealed-secrets
        repoURL: https://bitnami-labs.github.io/sealed-secrets
        chart: sealed-secrets
        version: "2.17.0"
        syncPolicy: aggressive
        group: security
        syncWave: 3

      # Governance Layer
      - name: gatekeeper
        namespace: gatekeeper-system
        repoURL: https://open-policy-agent.github.io/gatekeeper/charts
        chart: gatekeeper
        version: "3.18.2"
        syncPolicy: aggressive
        group: governance
        syncWave: 3

      # Enterprise Features - Ingress & API Management
      - name: external-dns
        namespace: external-dns
        repoURL: https://kubernetes-sigs.github.io/external-dns/
        chart: external-dns
        version: "1.16.0"
        syncPolicy: aggressive
        group: infrastructure
        syncWave: 0

      - name: kong
        namespace: api-gateway
        repoURL: https://charts.konghq.com
        chart: kong
        version: "2.52.0"
        syncPolicy: aggressive
        group: infrastructure
        syncWave: 2

      # Enterprise Features - Storage & Backup
      - name: longhorn
        namespace: longhorn-system
        repoURL: https://charts.longhorn.io
        chart: longhorn
        version: "1.10.1"
        syncPolicy: aggressive
        group: infrastructure
        syncWave: 4

      - name: velero
        namespace: velero
        repoURL: https://vmware-tanzu.github.io/helm-charts
        chart: velero
        version: "11.1.1"
        syncPolicy: aggressive
        group: infrastructure
        syncWave: 4

      # Enterprise Features - Advanced Observability
      - name: jaeger
        namespace: tracing
        repoURL: https://jaegertracing.github.io/helm-charts
        chart: jaeger
        version: "3.4.1"
        syncPolicy: aggressive
        group: observability
        syncWave: 2

      # Synthetic Monitoring - Endpoint Availability
      - name: blackbox-exporter
        namespace: monitoring
        repoURL: https://prometheus-community.github.io/helm-charts
        chart: prometheus-blackbox-exporter
        version: "9.2.0"
        syncPolicy: aggressive
        group: observability
        syncWave: 2

      # Enterprise Features - Container Registry
      - name: harbor
        namespace: harbor
        repoURL: https://helm.goharbor.io
        chart: harbor
        version: "1.18.0"
        syncPolicy: aggressive
        group: infrastructure
        syncWave: 4

  template:
    metadata:
      name: '{{ .name }}'
      labels:
        app.kubernetes.io/name: '{{ .name }}'
        app.kubernetes.io/group: '{{ .group }}'
        app.kubernetes.io/managed-by: applicationset
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      source:
        repoURL: '{{ .repoURL }}'
        chart: '{{ .chart }}'
        targetRevision: '{{ .version }}'
        helm:
          releaseName: '{{ .name }}'
          values: |
            {{- if not (or (eq .name "cert-manager") (eq .name "falco") (eq .name "gatekeeper") (eq .name "sealed-secrets") (eq .name "istio") (eq .name "kyverno") (eq .name "tempo") (eq .name "velero")) }}
            # Default minimal replicas for laptop deployment
            replicaCount: 1
            replicas: 1
            {{- end }}
            {{ if eq .name "cert-manager" }}
            # Enable CRD installation for cert-manager
            crds:
              enabled: true
            # cert-manager specific replica settings
            replicaCount: 1
            webhook:
              replicaCount: 1
            cainjector:
              replicaCount: 1
            {{ else if eq .name "falco" }}
            # Falco runtime security with modern eBPF driver for KIND/Docker Desktop
            replicaCount: 1
            # Use modern eBPF driver (doesn't need kernel headers)
            driver:
              kind: modern_ebpf
            # Falco is a runtime security event listener, not an HTTP UI service
            # It exposes events via gRPC and event streams, not HTTP
            webui:
              enabled: false
            {{ else if eq .name "gatekeeper" }}
            # Gatekeeper policy enforcement (OPA-based policy engine)
            replicas: 1
            audit:
              replicas: 1
            # Disable CRD upgrades (let operator manage them)
            disableMutation: false
            disableValidatingWebhook: false
            enableExternalData: true
            # Gatekeeper is a webhook-based policy engine, not an HTTP UI service
            auditViewer:
              enabled: false
            {{ else if eq .name "sealed-secrets" }}
            # Sealed Secrets
            replicaCount: 1
            {{ else if eq .name "prometheus" }}
            # Kube-prometheus-stack: Using v70.10.0 to avoid CRD annotation size issues
            # Disable CRD installation - CRDs are managed separately via prometheus-crds Application
            crds:
              enabled: false
            prometheus:
              prometheusSpec:
                podMonitorNamespaceSelector: {}
                replicas: 1
              # Prometheus ingress for Kong
              ingress:
                enabled: true
                ingressClassName: kong
                annotations:
                  konghq.com/strip-path: "true"
                hosts:
                  - prometheus.demo.local
                paths:
                  - /
            # Grafana ingress for Kong (part of kube-prometheus-stack)
            grafana:
              replicas: 1
              ingress:
                enabled: true
                ingressClassName: kong
                annotations:
                  konghq.com/strip-path: "true"
                hosts:
                  - grafana.demo.local
                path: /
              # Admin password should be managed via Sealed Secrets, not hardcoded
              adminPassword: ""
            kubeStateMetrics:
              enabled: true
              replicas: 1
            nodeExporter:
              enabled: true
            alertmanager:
              enabled: true
              alertmanagerSpec:
                replicas: 1
            {{ else if eq .name "external-dns" }}
            # External DNS for automatic DNS record management
            policy: sync
            registry: txt
            txtOwnerId: external-dns
            {{ else if eq .name "metrics-server" }}
            # Metrics-server for KIND - disable TLS verification for kubelet certificates
            # KIND kubelet certificates don't include IP SANs, so verification fails
            args:
              - --kubelet-insecure-tls
              - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
            {{ else if eq .name "loki" }}
            # Loki backend logging service (accessed via Grafana datasources, not HTTP UI)
            loki:
              ingress:
                enabled: false
            # Disable Grafana (use the one from prometheus stack instead)
            grafana:
              enabled: false
            # Configure datasource to not be default
            promtail:
              config:
                clients:
                  - url: http://loki:3100/loki/api/v1/push
            {{ else if eq .name "istio" }}
            # Istio service mesh
            pilot:
              replicaCount: 1
            {{ else if eq .name "kyverno" }}
            # Kyverno policy engine (webhook-based policy validation)
            replicaCount: 1
            admissionController:
              replicas: 1
            backgroundController:
              replicas: 1
            cleanupController:
              replicas: 1
            reportsController:
              replicas: 1
            # Fix kubectl image for cleanup jobs
            cleanupJobs:
              admissionReports:
                image:
                  registry: docker.io
                  repository: bitnami/kubectl
                  tag: "1.31"
              clusterAdmissionReports:
                image:
                  registry: docker.io
                  repository: bitnami/kubectl
                  tag: "1.31"
            # Kyverno is a webhook-based policy validator, not an HTTP UI service
            reportsUI:
              enabled: false
            {{ else if eq .name "tempo" }}
            # Tempo distributed tracing backend (accessed via Grafana datasources, not HTTP UI)
            replicas: 1
            ingress:
              enabled: false
            {{ else if eq .name "jaeger" }}
            # Jaeger distributed tracing with in-memory storage (suitable for KIND)
            provisionDataStore:
              cassandra: false
              elasticsearch: false
            storage:
              type: memory
            collector:
              service:
                type: LoadBalancer
            query:
              service:
                type: LoadBalancer
              # Jaeger query ingress for Kong
              ingress:
                enabled: true
                ingressClassName: kong
                annotations:
                  konghq.com/strip-path: "true"
                hosts:
                  - jaeger.demo.local
            {{ else if eq .name "kong" }}
            # Kong API Gateway with LoadBalancer and hostNetwork for KIND port access
            admin:
              enabled: true
              service:
                type: ClusterIP
            proxy:
              service:
                type: LoadBalancer
              containerPort: 8000
            # Use hostNetwork to make Kong accessible on host ports (80/443)
            podSecurityPolicy:
              enabled: false
            deployment:
              hostNetwork: true
              replicas: 1
            # Enable Kong Ingress Controller for ingress routing
            ingressController:
              enabled: true
              installCRDs: true
            {{ else if eq .name "harbor" }}
            # Harbor container registry
            persistence:
              enabled: true
              persistentVolumeClaim:
                registry:
                  size: 5Gi
            # Harbor database probe configuration (increase timeouts for PostgreSQL startup)
            database:
              livenessProbe:
                timeoutSeconds: 5
                initialDelaySeconds: 30
              readinessProbe:
                timeoutSeconds: 5
                initialDelaySeconds: 15
            # Harbor ingress for Kong
            expose:
              type: ingress
              ingress:
                className: kong
                annotations:
                  konghq.com/strip-path: "true"
                hosts:
                  core: harbor.demo.local
                  notary: harbor-notary.demo.local
            {{ else if eq .name "longhorn" }}
            # Longhorn storage - disable hooks due to ServiceAccount dependency issue
            # The pre-upgrade hook requires ServiceAccount that's created in Sync phase
            preUpgradeChecker:
              jobEnabled: false
            postUpgradeChecker:
              jobEnabled: false
            {{ else if eq .name "vault" }}
            # Vault with enabled ingress
            ui:
              enabled: true
            server:
              ingress:
                enabled: true
                ingressClassName: kong
                annotations:
                  konghq.com/strip-path: "true"
                hosts:
                  - host: vault.demo.local
                    paths: [/]
            {{ else if eq .name "velero" }}
            # Velero backup solution - disable CRD upgrade for fresh install
            upgradeCRDs: false
            kubectl:
              image:
                repository: docker.io/bitnami/kubectl
                tag: "1.31"
            configuration:
              backupStorageLocation:
                - name: default
                  provider: aws
                  bucket: velero-backups
                  config:
                    region: us-east-1
              volumeSnapshotLocation:
                - name: default
                  provider: aws
                  config:
                    region: us-east-1
            initContainers:
              - name: velero-plugin-for-aws
                image: velero/velero-plugin-for-aws:v1.9.0
                volumeMounts:
                  - mountPath: /target
                    name: plugins
            {{ end }}
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .namespace }}'
      syncPolicy:
        automated:
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - RespectIgnoreDifferences=true
          - SkipDryRunOnMissingResource=true
          - ServerSideApply=true
        managedNamespaceMetadata:
          labels: {}
          annotations: {}
        retry:
          limit: 10
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 5m
      ignoreDifferences:
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          jsonPointers:
            - /spec/conversion
            - /status
            - /metadata/annotations
        - group: batch
          kind: Job
          name: velero-upgrade-crds
          namespace: velero
        # Velero VolumeSnapshotLocation (ignore validation errors without cloud provider)
        - group: velero.io
          kind: VolumeSnapshotLocation
          name: default
          namespace: velero
          jsonPointers:
            - /spec
        - group: networking.k8s.io
          kind: Ingress
          name: loki
          namespace: monitoring
        - group: networking.k8s.io
          kind: Ingress
          name: vault
          namespace: vault
        - group: networking.k8s.io
          kind: Ingress
          name: prometheus-grafana
          namespace: monitoring
        - group: networking.k8s.io
          kind: Ingress
          name: prometheus-kube-prometheus-prometheus
          namespace: monitoring
        # Vault StatefulSet (ignore dynamic fields)
        - group: apps
          kind: StatefulSet
          name: vault
          namespace: vault
          jsonPointers:
            - /spec/volumeClaimTemplates
        # Istio webhook mutations (modified by istiod after startup, ignore ALL changes)
        - group: admissionregistration.k8s.io
          kind: MutatingWebhookConfiguration
          name: istio-sidecar-injector
          jsonPointers:
            - /webhooks
            - /metadata/annotations
            - /metadata/labels
        - group: admissionregistration.k8s.io
          kind: ValidatingWebhookConfiguration
          name: istio-validator-istio-system
          jsonPointers:
            - /webhooks
            - /metadata/annotations
            - /metadata/labels
        # Velero Deployment (modified by controller, ignore spec and metadata changes)
        - group: apps
          kind: Deployment
          name: velero
          namespace: velero
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        # Harbor StatefulSets (ignore dynamic fields updated by controller)
        - group: apps
          kind: StatefulSet
          namespace: harbor
          jsonPointers:
            - /spec/volumeClaimTemplates
            - /spec/template/metadata/annotations
            - /spec/replicas
        # Istio Deployment and HPA (modified by istiod)
        - group: apps
          kind: Deployment
          name: istiod
          namespace: istio-system
          jsonPointers:
            - /spec/template/metadata/annotations
            - /metadata/annotations
        - group: autoscaling
          kind: HorizontalPodAutoscaler
          name: istiod
          namespace: istio-system
          jsonPointers:
            - /spec
            - /status
        # Kyverno webhook mutations (rules auto-generated by admission webhook)
        - group: kyverno.io
          kind: ClusterPolicy
          jqPathExpressions:
            - '.spec.rules[] | select(.name | startswith("autogen-"))'
            - '.status'
        # Gatekeeper CRDs (auto-managed, ignore spec and metadata changes)
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: assign.mutations.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: assignimage.mutations.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: assignmetadata.mutations.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: configpodstatuses.status.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: configs.config.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: connectionpodstatuses.status.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: connections.connection.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: constraintpodstatuses.status.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: constrainttemplatepodstatuses.status.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: constrainttemplates.templates.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: expansiontemplate.expansion.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: expansiontemplatepodstatuses.status.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: modifyset.mutations.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: mutatorpodstatuses.status.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: providers.externaldata.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: syncsets.syncset.gatekeeper.sh
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        # Kyverno CRDs (auto-managed, ignore spec and metadata changes)
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: clusterpolicies.kyverno.io
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: policies.kyverno.io
          jsonPointers:
            - /spec
            - /metadata/annotations
            - /metadata/labels
  goTemplateOptions: ["missingkey=error"]
  templatePatch: |
    metadata:
      annotations:
        {{- if .syncWave }}
        argocd.argoproj.io/sync-wave: "{{ .syncWave }}"
        {{- end }}
    spec:
      syncPolicy:
        automated:
          prune: {{ if eq .syncPolicy "aggressive" }}true{{ else }}false{{ end }}
      # ignoreDifferences are already defined in template.spec, but we can't merge them here in templatePatch
      # The ignoreDifferences rules will apply to all generated applications

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: applicationset-defaults
  namespace: argocd
  labels:
    app.kubernetes.io/name: applicationset-defaults
data:
  # Platform applications inventory
  platform-apps: |
    infrastructure:
      - metrics-server
      - external-dns
      - kong
      - longhorn
      - velero
      - harbor
    observability:
      - prometheus
      - loki
      - tempo
      - jaeger
    service_mesh:
      - istio
    security:
      - cert-manager
      - vault
      - falco
      - kyverno
      - sealed-secrets
    governance:
      - gatekeeper
