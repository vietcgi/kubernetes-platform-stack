name: CI - Lint, Validate, and Test

on:
  pull_request:
    branches: [main, staging, dev]
  push:
    branches: [main, staging, dev]

jobs:
  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: pip install yamllint
      - run: yamllint -d relaxed argocd/ manifests/ .github/workflows/ && find helm -name "Chart.yaml" -o -name "values*.yaml" | xargs yamllint -d relaxed

  helm-lint:
    name: Helm Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v3
        with:
          version: v3.12.0
      - run: for chart in helm/*/; do [ -f "$chart/Chart.yaml" ] && helm dependency update "$chart" 2>/dev/null || true; done
      - run: |
          for chart in helm/*/; do
            [ -f "$chart/Chart.yaml" ] || continue
            helm lint "$chart" || exit 1
            # Skip template for library charts and charts with missing dependencies
            if ! grep -q "^type: library" "$chart/Chart.yaml"; then
              helm template test "$chart" > /dev/null 2>&1 || true
            fi
          done

  k8s-validate:
    name: Kubernetes Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: curl -sSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz -C /usr/local/bin
      - run: kubeconform -strict -summary -output json -ignore-missing-schemas argocd/

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: pip
      - run: pip install -r requirements.txt pytest pytest-cov
      - run: pytest tests/unit/ -v --cov=src
      - uses: codecov/codecov-action@v3

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: helm/kind-action@v1.13.0
        with:
          config: kind-config-ci.yaml
          cluster-name: chart-testing
      - uses: azure/setup-helm@v3
      - run: chmod +x deploy.sh && ./deploy.sh --force || true
      - run: sleep 30 && kubectl get deployments -A || true
      - run: pip install pytest && pytest tests/integration/ -v || true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          if grep -r "password" helm/ manifests/ argocd/ | grep -v "values.yaml" | grep -E "(password|token|api)[:=]" | grep -v "tlsDisable"; then
            echo "Hardcoded secrets found!"
            exit 1
          fi
      - run: echo "Security checks passed"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, helm-lint, k8s-validate, unit-tests, security, integration-tests]
    if: always()
    steps:
      - run: echo "CI pipeline completed"
