name: Security Scanning

on:
  push:
    branches: [main, staging, dev]
  pull_request:
    branches: [main, staging, dev]
  schedule:
    - cron: '0 0 * * 0'

jobs:
  trivy-scan:
    name: Container Image Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Build container image
        run: docker build -t myapp:test .

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: myapp:test
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

  kubesec-scan:
    name: Kubernetes Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubesec
        run: curl -sSL https://github.com/controlplaneio/kubesec/releases/latest/download/kubesec_linux_amd64.tar.gz | tar xz -C /usr/local/bin

      - name: Scan Kubernetes manifests
        run: |
          echo "Scanning Helm templates for security issues..."
          kubesec scan helm/my-app/templates/deployment.yaml || true
          kubesec scan manifests/**/*.yaml || true

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaksrc.toml
          report-format: json
          verbose: false

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Scan Python dependencies
        run: |
          pip install pip-audit
          pip-audit --desc || true

  kyverno-validate:
    name: Kyverno Policy Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kyverno CLI
        run: |
          KYVERNO_VERSION=$(curl -s https://api.github.com/repos/kyverno/kyverno/releases/latest | jq -r '.tag_name')
          curl -sSL "https://github.com/kyverno/kyverno/releases/download/${KYVERNO_VERSION}/kyverno-cli_${KYVERNO_VERSION}_linux_x86_64.tar.gz" | tar xz -C /usr/local/bin

      - name: Validate policies
        run: |
          kyverno apply manifests/kyverno/security-policies.yaml -d || true

  compliance-check:
    name: Compliance Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check no hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."
          if grep -r "password\|api_key\|secret_key" helm/ manifests/ argocd/ 2>/dev/null | grep -v "tlsDisable" | grep -v "values.yaml" | grep "=" || false; then
            echo "Found potential hardcoded secrets!"
            exit 1
          fi
          echo "No hardcoded secrets detected"

      - name: Verify TLS is enabled
        run: |
          echo "Verifying security best practices..."
          grep -r "tlsDisable: false" helm/ || echo "Check TLS configuration"
          grep -r "securityContext:" helm/ | wc -l

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [trivy-scan, kubesec-scan, secret-scan, compliance-check]
    if: always()
    steps:
      - run: echo "Security scans completed"
